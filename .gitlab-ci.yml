image: docker:19.03.12

stages:
  - build image
  - build project
  - push to github

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  JOMIGU_NODE_IMAGE: tsiminiya/jomigu-website-builder:${CI_COMMIT_REF_NAME}
  BACKUP_JOMIGU_NODE_IMAGE: tsiminiya/jomigu-website-builder:${CI_COMMIT_REF_NAME}

services:
  - docker:19.03.12-dind

build:image:
  stage: build image
  image: docker:dind
  before_script:
    - docker login -u tsiminiya -p $DOCKER_ACCESS_TOKEN
  script:
    - docker build ${PWD} -t tsiminiya/jomigu-website-builder:${CI_COMMIT_REF_NAME}
    - docker push ${BACKUP_JOMIGU_NODE_IMAGE}
    - docker tag ${BACKUP_JOMIGU_NODE_IMAGE} ${JOMIGU_NODE_IMAGE}
    - docker push ${JOMIGU_NODE_IMAGE}
    - docker run tsiminiya/jomigu-website-builder:${CI_COMMIT_REF_NAME} cat /root/.ssh/id_rsa.pub
  only:
    changes:
      - Dockerfile

build:project:
  stage: build project
  image: ${JOMIGU_NODE_IMAGE}
  script:
    - echo "$(cat /root/.ssh/id_rsa.pub)"
    - git remote set-url origin git@github.com:tsiminiya/jomigu.git
    - git fetch
    - git checkout main
    - git pull
  only:
    refs:
      - main
